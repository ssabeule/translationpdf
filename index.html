<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF 실시간 번역 뷰어 (텍스트+OCR 자동)</title>
  <style>
    :root { --brand:#007bff; --brand-dark:#0056b3; --bg:#f4f7f9; --panel:#fff; --border:#e0e0e0; --muted:#777; --text:#333; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--text)}
    #header{background:#fff;color:#333;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
    #header h1{margin:0;font-size:1.1rem;font-weight:600}
    #controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    #controls input[type="file"]{display:none}
    #controls label,#controls button{background:var(--brand);color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;border:none;font-size:.9rem;transition:background .2s}
    #controls button:disabled{background:#a0a0a0;cursor:not-allowed}
    #controls label:hover,#controls button:not(:disabled):hover{background:var(--brand-dark)}
    #page-info{display:flex;align-items:center;gap:10px;font-size:.9rem}
    select{padding:7px 10px;border:1px solid var(--border);border-radius:6px;background:#fff}
    #container{flex:1;display:flex;padding:14px;gap:14px;min-height:0}
    #pdf-viewer-container,#translation-container{flex:1;background:var(--panel);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel-header{padding:10px 14px;background:#f8f9fa;border-bottom:1px solid var(--border);font-weight:700;color:#555}
    #pdf-viewer{flex:1;overflow:auto;padding:10px}
    #translation-output{flex:1;padding:16px;overflow:auto;font-size:1.02rem;line-height:1.7;white-space:pre-wrap;color:#333}
    .loader-text{font-size:1.02rem;color:var(--muted);text-align:center;margin-top:38px}
    canvas{display:block;margin:0 auto;max-width:100%;box-shadow:0 0 10px rgba(0,0,0,.08)}
    .hint{font-size:.85rem;color:#666;margin-left:8px}
  </style>
  <!-- OCR 라이브러리 (일반 <script>는 CORS 문제 없음) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
</head>
<body>
  <div id="header">
    <h1>PDF 실시간 번역 뷰어</h1>
    <div id="controls">
      <label for="file-input">PDF 파일 선택</label>
      <input type="file" id="file-input" accept=".pdf"/>
      <div id="page-info">
        <button id="prev-page" disabled>이전</button>
        <span>페이지 <span id="page-num">0</span> / <span id="page-count">0</span></span>
        <button id="next-page" disabled>다음</button>
      </div>
      <select id="target-lang" title="번역 언어">
        <option value="ko">한국어</option>
        <option value="en">영어</option>
        <option value="ja">일본어</option>
        <option value="zh-CN">중국어(간체)</option>
        <option value="es">스페인어</option>
      </select>
      <label class="hint">
        OCR 언어:
        <select id="ocr-lang">
          <option value="eng">eng(영어)</option>
          <option value="kor">kor(한국어)</option>
          <option value="jpn">jpn(일본어)</option>
          <option value="chi_sim">chi_sim(중국어 간체)</option>
          <option value="spa">spa(스페인어)</option>
        </select>
      </label>
    </div>
  </div>

  <div id="container">
    <div id="pdf-viewer-container">
      <div class="panel-header">원본 PDF</div>
      <div id="pdf-viewer"><div class="loader-text">오른쪽에서 PDF 파일을 선택하세요.</div></div>
    </div>
    <div id="translation-container">
      <div class="panel-header">번역 결과</div>
      <div id="translation-output"><div class="loader-text">PDF를 선택하면 번역이 표시됩니다.</div></div>
    </div>
  </div>

  <script type="module">
    /* ① 네 Google Apps Script /exec 주소로 바꿔 넣기 */
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx2qmZg2voGlAu_UlxKC4NFQkfeNc4ouhvPY7TNffR-roCjHkW1DjI_uCyOmOHc4Z2AKQ/exec";

    /* ② pdf.js를 “같은 출처(lib/)”에서 로드 → CORS 문제 없음 */
    import * as pdfjsLib from './lib/pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './lib/pdf.worker.mjs';

    // DOM
    const fileInput = document.getElementById('file-input');
    const pdfViewer = document.getElementById('pdf-viewer');
    const translationOutput = document.getElementById('translation-output');
    const pageNumSpan = document.getElementById('page-num');
    const pageCountSpan = document.getElementById('page-count');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const targetLangSelect = document.getElementById('target-lang');
    const ocrLangSelect = document.getElementById('ocr-lang');

    let pdfDoc = null, currentPageNum = 1, isRendering = false;

    // 파일 선택 → 로드
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file || file.type !== 'application/pdf') { alert('PDF 파일만 선택하세요.'); return; }
      const fr = new FileReader();
      fr.onload = async (evt) => {
        const arr = new Uint8Array(evt.target.result);
        translationOutput.innerHTML = '<div class="loader-text">PDF 파일을 불러오는 중...</div>';
        try {
          const loadingTask = pdfjsLib.getDocument(arr);
          pdfDoc = await loadingTask.promise;
          pageCountSpan.textContent = pdfDoc.numPages;
          currentPageNum = 1;
          await renderPage(currentPageNum);
        } catch (err) {
          console.error('PDF 로딩 오류:', err);
          translationOutput.innerHTML = '<div class="loader-text">PDF 로딩 실패. 파일이 손상/암호화되었을 수 있습니다.</div>';
        }
      };
      fr.readAsArrayBuffer(file);
    });

    // 페이지 렌더 + 텍스트 추출(없으면 OCR) + 번역
    async function renderPage(num) {
      if (!pdfDoc || isRendering) return;
      isRendering = true;
      updatePageButtons(num);
      try {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: 1.8 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;

        pdfViewer.innerHTML = ''; pdfViewer.appendChild(canvas);
        pageNumSpan.textContent = String(num);

        translationOutput.innerHTML = '<div class="loader-text">텍스트 추출 중...</div>';

        // 1) pdf.js 텍스트 추출
        let text = '';
        try {
          const textContent = await page.getTextContent();
          text = textContent.items.map(it => it.str).join(' ').trim();
        } catch {}

        // 2) 추출 텍스트가 없으면 OCR 실행
        if (!text) {
          translationOutput.innerHTML = '<div class="loader-text">스캔본 감지 → OCR 중...</div>';
          text = await ocrFromCanvas(canvas, ocrLangSelect.value);
        }

        if (!text) {
          translationOutput.innerHTML = '<div class="loader-text">이 페이지에서 읽을 텍스트를 찾지 못했습니다.</div>';
          return;
        }

        // 3) 번역
        translationOutput.innerHTML = '<div class="loader-text">번역 중...</div>';
        const chunks = splitIntoChunks(text, 4500);
        const out = [];
        for (let i = 0; i < chunks.length; i++) {
          out.push(await translateText(chunks[i], targetLangSelect.value) || '');
          translationOutput.innerHTML = `<div class="loader-text">번역 중... (${i+1}/${chunks.length})</div>`;
        }
        translationOutput.textContent = out.join('\n');
      } catch (err) {
        console.error(`페이지 ${num} 렌더링 오류:`, err);
        translationOutput.innerHTML = `<div class="loader-text">페이지 ${num} 표시/번역 실패</div>`;
      } finally { isRendering = false; }
    }

    function updatePageButtons(num) {
      prevPageBtn.disabled = num <= 1;
      nextPageBtn.disabled = num >= (pdfDoc?.numPages || 0);
    }

    function splitIntoChunks(text, maxLen = 4500) {
      const sentences = text.split(/(?<=[.!?。！？])\s+/);
      const chunks = []; let buf = '';
      for (const s of sentences) {
        if ((buf + ' ' + s).trim().length <= maxLen) buf = (buf ? buf + ' ' : '') + s;
        else { if (buf) chunks.push(buf);
               if (s.length > maxLen) { for (let i = 0; i < s.length; i += maxLen) chunks.push(s.slice(i, i + maxLen)); buf = ''; }
               else buf = s; }
      }
      if (buf) chunks.push(buf);
      return chunks;
    }

    async function ocrFromCanvas(canvas, lang) {
      try {
        const { data: { text } } = await Tesseract.recognize(canvas, lang, {
          // 한국어 OCR이 필요하면 위 셀렉트에서 'kor' 선택
          // 처음 사용할 때 언어 데이터 다운받느라 조금 느릴 수 있음
        });
        return (text || '').trim();
      } catch (e) {
        console.error('OCR 오류:', e);
        return '';
      }
    }

    async function translateText(textToTranslate, targetLang) {
      try {
        // JSON으로 POST (GAS 코드가 doPost로 JSON 받도록 작성됨)
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: textToTranslate, targetLang })
        });
        if (!res.ok) throw new Error(`서버 응답 오류: ${res.status}`);
        const data = await res.json();
        if (data.translatedText) return data.translatedText;
        throw new Error(data.error || '번역 응답 형식 오류');
      } catch (err) {
        console.error('번역 API 호출 오류:', err);
        translationOutput.innerHTML = `<div class="loader-text">번역 서비스 연결 실패: ${err.message}</div>`;
        return '';
      }
    }

    prevPageBtn.addEventListener('click', () => { if (currentPageNum > 1) { currentPageNum--; renderPage(currentPageNum); } });
    nextPageBtn.addEventListener('click', () => { if (pdfDoc && currentPageNum < pdfDoc.numPages) { currentPageNum++; renderPage(currentPageNum); } });
    targetLangSelect.addEventListener('change', () => { if (pdfDoc) renderPage(currentPageNum); });
  </script>
</body>
</html>
