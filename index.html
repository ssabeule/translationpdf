<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF 실시간 번역 뷰어</title>
  <style>
    :root { --brand:#007bff; --brand-dark:#0056b3; --bg:#f4f7f9; --panel:#fff; --border:#e0e0e0; --muted:#777; --text:#333; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--text)}
    #header{background:#fff;color:#333;padding:10px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
    #header h1{margin:0;font-size:1.1rem;font-weight:600}
    #controls{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    #controls input[type="file"]{display:none}
    #controls label,#controls button{background:var(--brand);color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;border:none;font-size:.9rem;transition:background .2s}
    #controls button:disabled{background:#a0a0a0;cursor:not-allowed}
    #controls label:hover,#controls button:not(:disabled):hover{background:var(--brand-dark)}
    #page-info{display:flex;align-items:center;gap:10px;font-size:.9rem}
    select{padding:7px 10px;border:1px solid var(--border);border-radius:6px;background:#fff}
    #container{flex:1;display:flex;padding:14px;gap:14px;min-height:0}
    #pdf-viewer-container,#translation-container{flex:1;background:var(--panel);border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,.08);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel-header{padding:10px 14px;background:#f8f9fa;border-bottom:1px solid var(--border);font-weight:700;color:#555}
    #pdf-viewer{flex:1;overflow:auto;padding:10px}
    #translation-output{flex:1;padding:16px;overflow:auto;font-size:1.02rem;line-height:1.7;white-space:pre-wrap;color:#333}
    .loader-text{font-size:1.02rem;color:var(--muted);text-align:center;margin-top:38px}
    canvas{display:block;margin:0 auto;max-width:100%;box-shadow:0 0 10px rgba(0,0,0,.08)}
  </style>
</head>
<body>
  <div id="header">
    <h1>PDF 실시간 번역 뷰어</h1>
    <div id="controls">
      <label for="file-input">PDF 파일 선택</label>
      <input type="file" id="file-input" accept=".pdf"/>
      <div id="page-info">
        <button id="prev-page" disabled>이전</button>
        <span>페이지 <span id="page-num">0</span> / <span id="page-count">0</span></span>
        <button id="next-page" disabled>다음</button>
      </div>
      <select id="target-lang" title="번역 언어">
        <option value="ko">한국어</option>
        <option value="en">영어</option>
        <option value="ja">일본어</option>
        <option value="zh-CN">중국어(간체)</option>
        <option value="es">스페인어</option>
      </select>
    </div>
  </div>

  <div id="container">
    <div id="pdf-viewER-container">
      <div class="panel-header">원본 PDF</div>
      <div id="pdf-viewer"><div class="loader-text">오른쪽에서 PDF 파일을 선택하세요.</div></div>
    </div>
    <div id="translation-container">
      <div class="panel-header">번역 결과</div>
      <div id="translation-output"><div class="loader-text">PDF를 선택하면 번역이 표시됩니다.</div></div>
    </div>
  </div>

  <script type="module">
    /* 최신 /exec 주소 (네가 준 URL) */
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVuzDBnRocjzNvvsCwtNvL6FwKKrI1uGNlhlqk0X25t7DXJBDzbZdxR0LHvVWaOtgDSQ/exec";

    /* 같은 출처의 pdf.js 사용 → CORS 문제 없음 */
    import * as pdfjsLib from './lib/pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './lib/pdf.worker.mjs';

    // DOM
    const fileInput = document.getElementById('file-input');
    const pdfViewer = document.getElementById('pdf-viewer');
    const translationOutput = document.getElementById('translation-output');
    const pageNumSpan = document.getElementById('page-num');
    const pageCountSpan = document.getElementById('page-count');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const targetLangSelect = document.getElementById('target-lang');

    let pdfDoc = null, currentPageNum = 1, isRendering = false;

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file || file.type !== 'application/pdf') { alert('PDF 파일만 선택하세요.'); return; }
      const fr = new FileReader();
      fr.onload = async (evt) => {
        const arr = new Uint8Array(evt.target.result);
        translationOutput.innerHTML = '<div class="loader-text">PDF 파일을 불러오는 중...</div>';
        try {
          const loadingTask = pdfjsLib.getDocument(arr);
          pdfDoc = await loadingTask.promise;
          pageCountSpan.textContent = pdfDoc.numPages;
          currentPageNum = 1;
          await renderPage(currentPageNum);
        } catch (err) {
          console.error('PDF 로딩 오류:', err);
          translationOutput.innerHTML = '<div class="loader-text">PDF 로딩 실패.</div>';
        }
      };
      fr.readAsArrayBuffer(file);
    });

    async function renderPage(num) {
      if (!pdfDoc || isRendering) return;
      isRendering = true;
      updatePageButtons(num);
      try {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: 1.8 });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;

        pdfViewer.innerHTML = ''; pdfViewer.appendChild(canvas);
        pageNumSpan.textContent = String(num);

        translationOutput.innerHTML = '<div class="loader-text">번역 중...</div>';

        // 텍스트 추출
        const textContent = await page.getTextContent();
        const text = (textContent.items.map(it => it.str).join(' ') || '').trim();

        if (!text) {
          translationOutput.innerHTML = '<div class="loader-text">이 페이지에는 번역할 텍스트가 없습니다.</div>';
        } else {
          const chunks = splitIntoChunks(text, 4500);
          const out = [];
          for (let i = 0; i < chunks.length; i++) {
            const part = await translateText(chunks[i], targetLangSelect.value);
            out.push(part || '');
            translationOutput.innerHTML = `<div class="loader-text">번역 중... (${i+1}/${chunks.length})</div>`;
          }
          translationOutput.textContent = out.join('\n');
        }
      } catch (err) {
        console.error(`페이지 ${num} 렌더링 오류:`, err);
        translationOutput.innerHTML = `<div class="loader-text">페이지 ${num} 표시/번역 실패</div>`;
      } finally { isRendering = false; }
    }

    function updatePageButtons(num) {
      prevPageBtn.disabled = num <= 1;
      nextPageBtn.disabled = num >= (pdfDoc?.numPages || 0);
    }

    function splitIntoChunks(text, maxLen = 4500) {
      const sentences = text.split(/(?<=[.!?。！？])\s+/);
      const chunks = []; let buf = '';
      for (const s of sentences) {
        if ((buf + ' ' + s).trim().length <= maxLen) buf = (buf ? buf + ' ' : '') + s;
        else {
          if (buf) chunks.push(buf);
          if (s.length > maxLen) {
            for (let i = 0; i < s.length; i += maxLen) chunks.push(s.slice(i, i + maxLen));
            buf = '';
          } else {
            buf = s;
          }
        }
      }
      if (buf) chunks.push(buf);
      return chunks;
    }

    // ★ 프리플라이트(OPTIONS) 회피: x-www-form-urlencoded 로 POST
    async function translateText(textToTranslate, targetLang) {
      try {
        const body =
          'text=' + encodeURIComponent(textToTranslate) +
          '&targetLang=' + encodeURIComponent(targetLang);

        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });

        if (!res.ok) throw new Error(`서버 응답 오류: ${res.status}`);
        const data = await res.json();
        if (data.translatedText) return data.translatedText;
        return data.error ? `번역 오류: ${data.error}` : '';
      } catch (err) {
        console.error('번역 API 호출 오류:', err);
        return '';
      }
    }
  </script>
</body>
</html>
