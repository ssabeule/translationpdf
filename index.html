<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF 실시간 번역 뷰어 (업로드 버튼 고정)</title>

  <!-- 캐시 약화(선택) -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root { --brand:#007bff; --brand-dark:#0056b3; --bg:#f4f7f9; --panel:#fff; --border:#e0e0e0; --muted:#777; --text:#222; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--text)}
    #header{background:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);justify-content:space-between;position:sticky;top:0;z-index:10}
    #brand{display:flex;align-items:center;gap:12px}
    #brand h1{margin:0;font-size:1.06rem;font-weight:700}
    #meta{font-size:.85rem;color:#666}
    #controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .btn{background:var(--brand);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem}
    .btn:disabled{background:#a0a0a0;cursor:not-allowed}
    .btn:hover:not(:disabled){background:var(--brand-dark)}
    .pill{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--border);padding:6px 8px;border-radius:8px}
    .pill input[type="range"]{width:120px}
    select{padding:7px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    #container{flex:1;display:flex;gap:14px;padding:14px;min-height:0}
    #pdf-viewer-container,#translation-container{flex:1;background:var(--panel);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:flex;flex-direction:column;min-height:0;overflow:hidden}
    .panel-header{padding:10px 14px;background:#f8f9fa;border-bottom:1px solid var(--border);font-weight:700;color:#555;display:flex;align-items:center;gap:10px;justify-content:space-between}
    #pdf-toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    #pdf-viewer{flex:1;overflow:auto;padding:10px}
    canvas{display:block;max-width:100%;box-shadow:0 0 10px rgba(0,0,0,.08)}
    #translation-output{flex:1;overflow:auto;padding:18px;display:flex;justify-content:center}
    .translation-inner{width:100%;max-width:var(--colWidth, 840px);font-size:var(--fontSize, 18px);line-height:1.85;letter-spacing:.2px;white-space:pre-wrap;word-break:keep-all;color:#222}
    .translation-inner p{margin:0 0 1.05em}
    .muted{font-size:1.02rem;color:var(--muted);text-align:center;margin-top:38px}
    footer{padding:10px 16px;color:#666;font-size:.85rem;border-top:1px solid var(--border);text-align:right;background:#fff}
    .badge{font-size:.8rem;color:#333;background:#eef2ff;border:1px solid #c7d2fe;border-radius:6px;padding:4px 8px}
    .hide{display:none}
  </style>

  <script>
    // 모듈 캐시 버전 (lib import에만 사용)
    window.BUILD_VERSION = '2025-11-08-fix-upload-click-02';
  </script>
</head>
<body>
  <div id="header">
    <div id="brand">
      <h1>PDF 실시간 번역 뷰어</h1>
      <span id="meta">제작자 문태정 · v<span id="ver"></span></span>
    </div>
    <div id="controls" style="position:relative; z-index:11">
      <!-- 진짜 input은 숨기고 버튼으로 트리거 -->
      <input type="file" id="file-input" class="hide" accept=".pdf,application/pdf"/>
      <button id="open-file" class="btn" type="button">PDF 파일 선택</button>

      <div class="pill">
        <button id="prev-page" class="btn" disabled>이전</button>
        <span>페이지 <span id="page-num">0</span>/<span id="page-count">0</span></span>
        <button id="next-page" class="btn" disabled>다음</button>
      </div>

      <select id="target-lang" title="번역 언어">
        <option value="ko">한국어</option>
        <option value="en">영어</option>
        <option value="ja">일본어</option>
        <option value="zh-CN">중국어(간체)</option>
        <option value="es">스페인어</option>
      </select>

      <div class="pill">
        <span>글자</span>
        <input id="font-size" type="range" min="16" max="24" value="18">
      </div>
      <div class="pill">
        <span>열폭</span>
        <input id="col-width" type="range" min="640" max="1040" value="840">
      </div>
    </div>
  </div>

  <div id="container">
    <div id="pdf-viewer-container">
      <div class="panel-header">
        <span>원본 PDF</span>
        <div id="pdf-toolbar">
          <button id="zoom-out" class="btn" title="축소">－</button>
          <span class="badge"><span id="zoom-percent">100</span>%</span>
          <button id="zoom-in" class="btn" title="확대">＋</button>
          <button id="zoom-reset" class="btn" title="100%로">100%</button>
          <button id="zoom-fit" class="btn" title="가로폭 맞춤">맞춤</button>
          <span class="badge" id="zoom-mode">수동</span>
        </div>
      </div>
      <div id="pdf-viewer"><div class="muted">오른쪽에서 PDF 파일을 선택하세요.</div></div>
    </div>

    <div id="translation-container">
      <div class="panel-header">번역 결과</div>
      <div id="translation-output">
        <div class="translation-inner" id="translation-inner">
          <div class="muted">PDF를 선택하면 번역이 표시됩니다.</div>
        </div>
      </div>
    </div>
  </div>

  <footer>제작자 문태정 · v<span id="ver2"></span></footer>

  <script type="module">
    // --- 상단 버전 텍스트 ---
    document.getElementById('ver').textContent =
      document.getElementById('ver2').textContent = (window.BUILD_VERSION || 'dev');

    // === 전역 DOM ===
    const fileInput = document.getElementById('file-input');
    const openFileBtn = document.getElementById('open-file');
    const pdfViewer = document.getElementById('pdf-viewer');
    const translationInner = document.getElementById('translation-inner');
    const pageNumSpan = document.getElementById('page-num');
    const pageCountSpan = document.getElementById('page-count');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const targetLangSelect = document.getElementById('target-lang');
    const fontSizeRange = document.getElementById('font-size');
    const colWidthRange = document.getElementById('col-width');

    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomInBtn  = document.getElementById('zoom-in');
    const zoomResetBtn = document.getElementById('zoom-reset');
    const zoomFitBtn = document.getElementById('zoom-fit');
    const zoomPercent = document.getElementById('zoom-percent');
    const zoomModeBadge = document.getElementById('zoom-mode');

    // === 상태 ===
    let pdfjsLib = null;      // 동적 import 후 채워짐
    let pdfDoc = null, currentPageNum = 1, isRendering = false;
    let scale = 1.0;
    let scaleMode = 'manual'; // 'manual' | 'fit-width'
    const SCALE_MIN = 0.5, SCALE_MAX = 3.0, SCALE_STEP = 0.1;

    // ★ 최신 /exec 주소 (네 GAS 웹앱)
    const APPS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbwzvhcUBXumoOm6KHaCNWvtW23KFakzfAJgKFLrPali56q0a2yiRLSpBfsY25t8Yp_CJw/exec";

    // 1) 버튼은 무조건 동작
    openFileBtn.addEventListener('click', () => fileInput.click());

    // 2) 가독성 슬라이더
    function applyReaderStyle(){
      translationInner.style.setProperty('--fontSize', fontSizeRange.value + 'px');
      translationInner.style.setProperty('--colWidth', colWidthRange.value + 'px');
    }
    fontSizeRange.addEventListener('input', applyReaderStyle);
    colWidthRange.addEventListener('input', applyReaderStyle);
    applyReaderStyle();

    // 3) JSONP (CORS 우회)
    function jsonp(url, params = {}){
      return new Promise((resolve, reject)=>{
        const cb = '__jsonp_cb_' + Math.random().toString(36).slice(2);
        const qs = new URLSearchParams({ ...params, callback: cb, _t: Date.now() }).toString();
        const s = document.createElement('script');
        s.src = url + '?' + qs; s.async = true;
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
        function cleanup(){ delete window[cb]; s.remove(); }
        document.head.appendChild(s);
      });
    }
    async function translateText(textToTranslate, targetLang){
      try{
        const data = await jsonp(APPS_SCRIPT_URL, { text: textToTranslate, targetLang });
        if (data && data.translatedText) return data.translatedText;
        if (data && data.error) return '번역 오류: ' + data.error;
        return '';
      }catch(err){
        console.error('번역 JSONP 호출 오류:', err);
        return '번역 실패: ' + err.message;
      }
    }

    // 4) pdf.js 동적 로더 (여기서 실패해도 버튼은 이미 동작함)
    async function ensurePdfJs(){
      if (pdfjsLib) return pdfjsLib;
      try{
        pdfjsLib = await import('./lib/pdf.mjs?v=' + (window.BUILD_VERSION || 'dev'));
        pdfjsLib.GlobalWorkerOptions.workerSrc = './lib/pdf.worker.mjs?v=' + (window.BUILD_VERSION || 'dev');
        return pdfjsLib;
      }catch(err){
        console.error('pdf.js 로드 실패:', err);
        alert('pdf.js 파일을 찾을 수 없습니다. 저장소에 lib/pdf.mjs 와 lib/pdf.worker.mjs 가 있는지 확인하세요.');
        throw err;
      }
    }

    // 5) 파일 선택 → 그 때 pdf.js 로드
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (file.type && !/pdf/i.test(file.type)) { alert('PDF 파일만 선택하세요.'); return; }

      translationInner.innerHTML = '<div class="muted">PDF 파일을 불러오는 중...</div>';

      try{
        await ensurePdfJs(); // 동적 import
        const fr = new FileReader();
        fr.onload = async (evt) => {
          const arr = new Uint8Array(evt.target.result);
          try {
            const task = pdfjsLib.getDocument(arr);
            pdfDoc = await task.promise;
            pageCountSpan.textContent = pdfDoc.numPages;
            currentPageNum = 1;
            scaleMode = 'fit-width';
            await renderPage(currentPageNum);
          } catch (err) {
            console.error('PDF 로딩 오류:', err);
            translationInner.innerHTML = '<div class="muted">PDF 로딩 실패.</div>';
          }
        };
        fr.readAsArrayBuffer(file);
      }catch{
        // ensurePdfJs에서 이미 안내함
      }
    });

    // 배율 UI/유틸
    function updateZoomUI(){
      zoomPercent.textContent = Math.round(scale * 100);
      zoomModeBadge.textContent = (scaleMode === 'fit-width') ? '맞춤' : '수동';
    }
    function clamp(num, min, max){ return Math.max(min, Math.min(max, num)); }
    async function computeFitWidthScale(page){
      const baseViewport = page.getViewport({ scale: 1.0 });
      const containerWidth = document.getElementById('pdf-viewer').clientWidth - 4;
      const s = clamp(containerWidth / baseViewport.width, SCALE_MIN, SCALE_MAX);
      return s || 1.0;
    }

    // 페이지 렌더
    async function renderPage(num) {
      if (!pdfDoc || isRendering) return;
      isRendering = true;

      try {
        const page = await pdfDoc.getPage(num);
        if (scaleMode === 'fit-width') {
          scale = await computeFitWidthScale(page);
        }

        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;

        pdfViewer.innerHTML = '';
        pdfViewer.appendChild(canvas);

        currentPageNum = num;
        pageNumSpan.textContent = String(num);
        prevPageBtn.disabled = (num <= 1);
        nextPageBtn.disabled = (num >= pdfDoc.numPages);
        updateZoomUI();

        // 텍스트 추출 → 문단화 → 번역(JSONP)
        translationInner.innerHTML = `<div class="muted">번역 중... (페이지 ${num}/${pdfDoc.numPages})</div>`;
        const textContent = await page.getTextContent();
        const laidOut = buildLaidOutText(textContent);
        const chunks = splitIntoChunks(laidOut, 4500);
        const out = [];
        for (let i = 0; i < chunks.length; i++) {
          const part = await translateText(chunks[i], targetLangSelect.value);
          out.push(part || '');
          translationInner.innerHTML = `<div class="muted">번역 중... (${i+1}/${chunks.length})</div>`;
        }
        const html = out.join('\n')
          .split(/\n{2,}/)
          .map(p => `<p>${escapeHtml(p.trim())}</p>`)
          .join('');
        translationInner.innerHTML = html || '<div class="muted">빈 결과</div>';
        document.getElementById('translation-output').scrollTop = 0;

      } catch (err) {
        console.error(`페이지 ${num} 표시/번역 실패:`, err);
        translationInner.innerHTML = `<div class="muted">페이지 ${num} 표시/번역 실패</div>`;
      } finally {
        isRendering = false;
      }
    }

    // 네비 & 줌
    prevPageBtn.addEventListener('click', () => { if (currentPageNum > 1) renderPage(currentPageNum - 1); });
    nextPageBtn.addEventListener('click', () => { if (pdfDoc && currentPageNum < pdfDoc.numPages) renderPage(currentPageNum + 1); });
    targetLangSelect.addEventListener('change', () => { if (pdfDoc) renderPage(currentPageNum); });

    zoomInBtn.addEventListener('click', ()=>{ if (!pdfDoc) return; scaleMode='manual'; scale = clamp(scale + SCALE_STEP, SCALE_MIN, SCALE_MAX); renderPage(currentPageNum); });
    zoomOutBtn.addEventListener('click', ()=>{ if (!pdfDoc) return; scaleMode='manual'; scale = clamp(scale - SCALE_STEP, SCALE_MIN, SCALE_MAX); renderPage(currentPageNum); });
    zoomResetBtn.addEventListener('click', ()=>{ if (!pdfDoc) return; scaleMode='manual'; scale = 1.0; renderPage(currentPageNum); });
    zoomFitBtn.addEventListener('click',   ()=>{ if (!pdfDoc) return; scaleMode='fit-width'; renderPage(currentPageNum); });

    document.getElementById('pdf-viewer').addEventListener('wheel', (e)=>{
      if (!pdfDoc) return;
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        scaleMode = 'manual';
        const delta = (e.deltaY < 0 ? +SCALE_STEP : -SCALE_STEP);
        scale = clamp(scale + delta, SCALE_MIN, SCALE_MAX);
        renderPage(currentPageNum);
      }
    }, { passive:false });

    window.addEventListener('resize', ()=>{
      if (pdfDoc && scaleMode === 'fit-width') renderPage(currentPageNum);
    });

    // ===== 가독성 유틸 =====
    function buildLaidOutText(textContent){
      const items = textContent.items || [];
      const lines = [];
      let buf = '';

      const pushLine = () => {
        const t = buf.trim();
        if (t.length) lines.push(t);
        buf = '';
      };

      for (const it of items) {
        const s = it.str || '';
        if (!s) continue;
        if (buf && !/[\s-]$/.test(buf) && !/^[\s,.;:!?)]/.test(s)) buf += ' ';
        buf += s;
        if (it.hasEOL) pushLine();
      }
      pushLine();

      // 하이픈 줄바꿈 보정
      for (let i=0;i<lines.length-1;i++){
        const a = lines[i], b = lines[i+1];
        if (/[A-Za-z가-힣0-9]-$/.test(a) && /^[a-zA-Z가-힣0-9]/.test(b)) {
          lines[i]   = a.replace(/-$/, '') + b.replace(/^\s+/, '');
          lines.splice(i+1, 1);
          i--;
        }
      }

      const paras = [];
      let pbuf = '';
      const isList = (t)=>/^\s*(?:[\u2022•\-–]|\d+\.)\s+/.test(t);
      const endsWithSentencePunct = (t)=>/[.!?。！？…’”)"\]]$/.test(t);
      const pushPara = ()=>{ const t = pbuf.trim(); if (t) paras.push(t); pbuf = ''; };

      for (let i=0;i<lines.length;i++){
        const L = lines[i].trim();
        if (!L) { pushPara(); continue; }
        if (isList(L)) { pushPara(); paras.push(L); continue; }
        if (pbuf) pbuf += ' ' + L; else pbuf = L;
        const next = lines[i+1]?.trim() || '';
        if (!next || isList(next) || endsWithSentencePunct(L)) pushPara();
      }
      pushPara();

      return paras.map(x => x.replace(/\s+/g,' ').trim()).join('\n\n');
    }

    function splitIntoChunks(text, maxLen = 4500) {
      const paragraphs = text.split(/\n{2,}/);
      const out = [];
      for (let p of paragraphs) {
        p = p.trim();
        if (!p) continue;
        if (p.length <= maxLen) { out.push(p); continue; }
        const sents = p.split(/(?<=[.!?。！？…])\s+/);
        let buf = '';
        for (const s of sents) {
          if ((buf + ' ' + s).trim().length <= maxLen) buf = (buf ? buf + ' ' : '') + s;
          else { if (buf) out.push(buf); buf = s; }
        }
        if (buf) out.push(buf);
      }
      return out.length ? out : [text.slice(0, maxLen)];
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
