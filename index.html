<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF ì‹¤ì‹œê°„ ë²ˆì—­ ë·°ì–´ (ê°€ë…ì„±+ì¤ŒÂ·JSONP)</title>

  <!-- ìºì‹œ ì•½í™” -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <style>
    :root { --brand:#007bff; --brand-dark:#0056b3; --bg:#f4f7f9; --panel:#fff; --border:#e0e0e0; --muted:#777; --text:#222; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--text)}
    #header{background:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border);justify-content:space-between;position:sticky;top:0;z-index:5}
    #brand{display:flex;align-items:center;gap:12px}
    #brand h1{margin:0;font-size:1.06rem;font-weight:700}
    #meta{font-size:.85rem;color:#666}
    #controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    #controls input[type="file"]{display:none}
    .btn{background:var(--brand);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem}
    .btn:disabled{background:#a0a0a0;cursor:not-allowed}
    .btn:hover:not(:disabled){background:var(--brand-dark)}
    .pill{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--border);padding:6px 8px;border-radius:8px}
    .pill input[type="range"]{width:120px}
    select{padding:7px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    #container{flex:1;display:flex;gap:14px;padding:14px;min-height:0}
    #pdf-viewer-container,#translation-container{flex:1;background:var(--panel);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:flex;flex-direction:column;min-height:0;overflow:hidden}
    .panel-header{padding:10px 14px;background:#f8f9fa;border-bottom:1px solid var(--border);font-weight:700;color:#555;display:flex;align-items:center;gap:10px;justify-content:space-between}
    #pdf-toolbar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
    #pdf-viewer{flex:1;overflow:auto;padding:10px}
    canvas{display:block;max-width:100%;box-shadow:0 0 10px rgba(0,0,0,.08)}
    #translation-output{flex:1;overflow:auto;padding:18px;display:flex;justify-content:center}
    .translation-inner{width:100%;max-width:var(--colWidth, 840px);font-size:var(--fontSize, 18px);line-height:1.85;letter-spacing:.2px;white-space:pre-wrap;word-break:keep-all;color:#222}
    .translation-inner p{margin:0 0 1.05em}
    .muted{font-size:1.02rem;color:var(--muted);text-align:center;margin-top:38px}
    footer{padding:10px 16px;color:#666;font-size:.85rem;border-top:1px solid var(--border);text-align:right;background:#fff}
    .badge{font-size:.8rem;color:#333;background:#eef2ff;border:1px solid #c7d2fe;border-radius:6px;padding:4px 8px}
  </style>

  <script>
    // ìë™ ë²„ì „ ì¿¼ë¦¬ìŠ¤íŠ¸ë§ ë¶€ì°© â†’ ìºì‹œ ìš°íšŒ
    const BUILD_VERSION = '2025-11-08-zoom-01';
    (function ensureVersionParam(){
      const url = new URL(location.href);
      const v = url.searchParams.get('v');
      if (v !== BUILD_VERSION) {
        url.searchParams.set('v', BUILD_VERSION);
        location.replace(url.toString());
      }
    })();
  </script>
</head>
<body>
  <div id="header">
    <div id="brand">
      <h1>PDF ì‹¤ì‹œê°„ ë²ˆì—­ ë·°ì–´</h1>
      <span id="meta">ì œì‘ì ë¬¸íƒœì • Â· v<span id="ver"></span></span>
    </div>
    <div id="controls">
      <label class="btn" for="file-input">PDF íŒŒì¼ ì„ íƒ</label>
      <input type="file" id="file-input" accept=".pdf"/>

      <div class="pill">
        <button id="prev-page" class="btn" disabled>ì´ì „</button>
        <span>í˜ì´ì§€ <span id="page-num">0</span>/<span id="page-count">0</span></span>
        <button id="next-page" class="btn" disabled>ë‹¤ìŒ</button>
      </div>

      <select id="target-lang" title="ë²ˆì—­ ì–¸ì–´">
        <option value="ko">í•œêµ­ì–´</option>
        <option value="en">ì˜ì–´</option>
        <option value="ja">ì¼ë³¸ì–´</option>
        <option value="zh-CN">ì¤‘êµ­ì–´(ê°„ì²´)</option>
        <option value="es">ìŠ¤í˜ì¸ì–´</option>
      </select>

      <div class="pill">
        <span>ê¸€ì</span>
        <input id="font-size" type="range" min="16" max="24" value="18">
      </div>
      <div class="pill">
        <span>ì—´í­</span>
        <input id="col-width" type="range" min="640" max="1040" value="840">
      </div>
    </div>
  </div>

  <div id="container">
    <div id="pdf-viewer-container">
      <div class="panel-header">
        <span>ì›ë³¸ PDF</span>
        <!-- ğŸ” í™•ëŒ€/ì¶•ì†Œ íˆ´ë°” -->
        <div id="pdf-toolbar">
          <button id="zoom-out" class="btn" title="ì¶•ì†Œ">ï¼</button>
          <span class="badge"><span id="zoom-percent">100</span>%</span>
          <button id="zoom-in" class="btn" title="í™•ëŒ€">ï¼‹</button>
          <button id="zoom-reset" class="btn" title="100%ë¡œ">100%</button>
          <button id="zoom-fit" class="btn" title="ê°€ë¡œí­ ë§ì¶¤">ë§ì¶¤</button>
          <span class="badge" id="zoom-mode">ìˆ˜ë™</span>
        </div>
      </div>
      <div id="pdf-viewer"><div class="muted">ì˜¤ë¥¸ìª½ì—ì„œ PDF íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</div></div>
    </div>

    <div id="translation-container">
      <div class="panel-header">ë²ˆì—­ ê²°ê³¼</div>
      <div id="translation-output">
        <div class="translation-inner" id="translation-inner">
          <div class="muted">PDFë¥¼ ì„ íƒí•˜ë©´ ë²ˆì—­ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </div>
    </div>
  </div>

  <footer>ì œì‘ì ë¬¸íƒœì • Â· v<span id="ver2"></span></footer>

  <script type="module">
    // ë²„ì „ í…ìŠ¤íŠ¸ í‘œì‹œ
    document.getElementById('ver').textContent =
      document.getElementById('ver2').textContent = (window.BUILD_VERSION || 'dev');

    /* â˜… ìµœì‹  /exec ì£¼ì†Œ(ë„¤ ë°°í¬ ì£¼ì†Œë¡œ ìœ ì§€) */
    const APPS_SCRIPT_URL =
      "https://script.google.com/macros/s/AKfycbwzvhcUBXumoOm6KHaCNWvtW23KFakzfAJgKFLrPali56q0a2yiRLSpBfsY25t8Yp_CJw/exec";

    /* ê°™ì€ ì¶œì²˜ pdf.js (lib: pdf.mjs, pdf.worker.mjs) */
    import * as pdfjsLib from './lib/pdf.mjs?v=' + (window.BUILD_VERSION || 'dev');
    pdfjsLib.GlobalWorkerOptions.workerSrc = './lib/pdf.worker.mjs?v=' + (window.BUILD_VERSION || 'dev');

    // DOM
    const fileInput = document.getElementById('file-input');
    const pdfViewer = document.getElementById('pdf-viewer');
    const translationInner = document.getElementById('translation-inner');
    const pageNumSpan = document.getElementById('page-num');
    const pageCountSpan = document.getElementById('page-count');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const targetLangSelect = document.getElementById('target-lang');
    const fontSizeRange = document.getElementById('font-size');
    const colWidthRange = document.getElementById('col-width');

    // ğŸ” ì¤Œ ê´€ë ¨
    const zoomOutBtn = document.getElementById('zoom-out');
    const zoomInBtn  = document.getElementById('zoom-in');
    const zoomResetBtn = document.getElementById('zoom-reset');
    const zoomFitBtn = document.getElementById('zoom-fit');
    const zoomPercent = document.getElementById('zoom-percent');
    const zoomModeBadge = document.getElementById('zoom-mode');

    let pdfDoc = null, currentPageNum = 1, isRendering = false;
    let scale = 1.0;                 // í˜„ì¬ ë°°ìœ¨(1.0 = 100%)
    let scaleMode = 'manual';        // 'manual' | 'fit-width'
    const SCALE_MIN = 0.5, SCALE_MAX = 3.0, SCALE_STEP = 0.1;

    // ê°€ë…ì„± ìŠ¬ë¼ì´ë”
    function applyReaderStyle(){
      translationInner.style.setProperty('--fontSize', fontSizeRange.value + 'px');
      translationInner.style.setProperty('--colWidth', colWidthRange.value + 'px');
    }
    fontSizeRange.addEventListener('input', applyReaderStyle);
    colWidthRange.addEventListener('input', applyReaderStyle);
    applyReaderStyle();

    // JSONP ìœ í‹¸ (CORS ìš°íšŒ)
    function jsonp(url, params = {}){
      return new Promise((resolve, reject)=>{
        const cb = '__jsonp_cb_' + Math.random().toString(36).slice(2);
        const qs = new URLSearchParams({ ...params, callback: cb, _t: Date.now() }).toString();
        const s = document.createElement('script');
        s.src = url + '?' + qs; s.async = true;
        window[cb] = (data)=>{ cleanup(); resolve(data); };
        s.onerror = ()=>{ cleanup(); reject(new Error('JSONP load error')); };
        function cleanup(){ delete window[cb]; s.remove(); }
        document.head.appendChild(s);
      });
    }

    async function translateText(textToTranslate, targetLang){
      try{
        const data = await jsonp(APPS_SCRIPT_URL, { text: textToTranslate, targetLang });
        if (data && data.translatedText) return data.translatedText;
        if (data && data.error) return 'ë²ˆì—­ ì˜¤ë¥˜: ' + data.error;
        return '';
      }catch(err){
        console.error('ë²ˆì—­ JSONP í˜¸ì¶œ ì˜¤ë¥˜:', err);
        return 'ë²ˆì—­ ì‹¤íŒ¨: ' + err.message;
      }
    }

    // íŒŒì¼ ì„ íƒ
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file || file.type !== 'application/pdf') { alert('PDF íŒŒì¼ë§Œ ì„ íƒí•˜ì„¸ìš”.'); return; }
      const fr = new FileReader();
      fr.onload = async (evt) => {
        const arr = new Uint8Array(evt.target.result);
        translationInner.innerHTML = '<div class="muted">PDF íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        try {
          const task = pdfjsLib.getDocument(arr);
          pdfDoc = await task.promise;
          pageCountSpan.textContent = pdfDoc.numPages;
          currentPageNum = 1;

          // ì²« í˜ì´ì§€ì—ì„œ ê°€ë¡œí­ ë§ì¶¤ ê³„ì‚°
          scaleMode = 'fit-width';
          await renderPage(currentPageNum); // renderPage ë‚´ë¶€ì—ì„œ fit-width ê³„ì‚°
        } catch (err) {
          console.error('PDF ë¡œë”© ì˜¤ë¥˜:', err);
          translationInner.innerHTML = '<div class="muted">PDF ë¡œë”© ì‹¤íŒ¨.</div>';
        }
      };
      fr.readAsArrayBuffer(file);
    });

    // ë°°ìœ¨ í‘œì‹œ/ëª¨ë“œ ë°°ì§€
    function updateZoomUI(){
      zoomPercent.textContent = Math.round(scale * 100);
      zoomModeBadge.textContent = (scaleMode === 'fit-width') ? 'ë§ì¶¤' : 'ìˆ˜ë™';
    }

    function clamp(num, min, max){ return Math.max(min, Math.min(max, num)); }

    // fit-width ê³„ì‚° : í˜ì´ì§€ ì›ë³¸ í­ ëŒ€ë¹„ viewportì»¨í…Œì´ë„ˆ í­
    async function computeFitWidthScale(page){
      const baseViewport = page.getViewport({ scale: 1.0 });
      const containerWidth = document.getElementById('pdf-viewer').clientWidth - 4; // íŒ¨ë”©ì—¬ë°± ì—¬ìœ 
      const s = clamp(containerWidth / baseViewport.width, SCALE_MIN, SCALE_MAX);
      return s || 1.0;
    }

    // í˜ì´ì§€ ë Œë”
    async function renderPage(num) {
      if (!pdfDoc || isRendering) return;
      isRendering = true;

      try {
        const page = await pdfDoc.getPage(num);

        // ëª¨ë“œê°€ ë§ì¶¤ì´ë©´ ìŠ¤ì¼€ì¼ ì¬ê³„ì‚°
        if (scaleMode === 'fit-width') {
          scale = await computeFitWidthScale(page);
        }

        const viewport = page.getViewport({ scale });
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;

        pdfViewer.innerHTML = '';
        pdfViewer.appendChild(canvas);

        currentPageNum = num;
        pageNumSpan.textContent = String(num);
        prevPageBtn.disabled = (num <= 1);
        nextPageBtn.disabled = (num >= pdfDoc.numPages);
        updateZoomUI();

        // í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ë ˆì´ì•„ì›ƒ ë³´ì • â†’ ë²ˆì—­(JSONP)
        translationInner.innerHTML = `<div class="muted">ë²ˆì—­ ì¤‘... (í˜ì´ì§€ ${num}/${pdfDoc.numPages})</div>`;
        const textContent = await page.getTextContent();
        const laidOut = buildLaidOutText(textContent);
        const chunks = splitIntoChunks(laidOut, 4500);
        const out = [];
        for (let i = 0; i < chunks.length; i++) {
          const part = await translateText(chunks[i], targetLangSelect.value);
          out.push(part || '');
          translationInner.innerHTML = `<div class="muted">ë²ˆì—­ ì¤‘... (${i+1}/${chunks.length})</div>`;
        }
        const html = out.join('\n')
          .split(/\n{2,}/)
          .map(p => `<p>${escapeHtml(p.trim())}</p>`)
          .join('');
        translationInner.innerHTML = html || '<div class="muted">ë¹ˆ ê²°ê³¼</div>';
        document.getElementById('translation-output').scrollTop = 0;

      } catch (err) {
        console.error(`í˜ì´ì§€ ${num} í‘œì‹œ/ë²ˆì—­ ì‹¤íŒ¨:`, err);
        translationInner.innerHTML = `<div class="muted">í˜ì´ì§€ ${num} í‘œì‹œ/ë²ˆì—­ ì‹¤íŒ¨</div>`;
      } finally {
        isRendering = false;
      }
    }

    // ë„¤ë¹„
    prevPageBtn.addEventListener('click', () => { if (currentPageNum > 1) renderPage(currentPageNum - 1); });
    nextPageBtn.addEventListener('click', () => { if (pdfDoc && currentPageNum < pdfDoc.numPages) renderPage(currentPageNum + 1); });
    targetLangSelect.addEventListener('change', () => { if (pdfDoc) renderPage(currentPageNum); });

    // ğŸ” ì¤Œ ë²„íŠ¼/ë‹¨ì¶•í‚¤
    zoomInBtn.addEventListener('click', ()=>{ scaleMode='manual'; scale = clamp(scale + SCALE_STEP, SCALE_MIN, SCALE_MAX); renderPage(currentPageNum); });
    zoomOutBtn.addEventListener('click', ()=>{ scaleMode='manual'; scale = clamp(scale - SCALE_STEP, SCALE_MIN, SCALE_MAX); renderPage(currentPageNum); });
    zoomResetBtn.addEventListener('click', ()=>{ scaleMode='manual'; scale = 1.0; renderPage(currentPageNum); });
    zoomFitBtn.addEventListener('click',   ()=>{ scaleMode='fit-width'; renderPage(currentPageNum); });

    // Ctrl + ë§ˆìš°ìŠ¤íœ ë¡œ í™•ëŒ€/ì¶•ì†Œ
    document.getElementById('pdf-viewer').addEventListener('wheel', (e)=>{
      if (!pdfDoc) return;
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        scaleMode = 'manual';
        const delta = (e.deltaY < 0 ? +SCALE_STEP : -SCALE_STEP);
        scale = clamp(scale + delta, SCALE_MIN, SCALE_MAX);
        renderPage(currentPageNum);
      }
    }, { passive:false });

    // ì°½ í¬ê¸° ë³€ê²½ ì‹œ ë§ì¶¤ ëª¨ë“œë©´ ì¬ë Œë”
    window.addEventListener('resize', ()=>{
      if (pdfDoc && scaleMode === 'fit-width') renderPage(currentPageNum);
    });

    window.addEventListener('keydown', (e) => {
      if (!pdfDoc) return;
      if (e.key === 'ArrowRight' || e.key === 'PageDown') { e.preventDefault(); nextPageBtn.click(); }
      if (e.key === 'ArrowLeft'  || e.key === 'PageUp')   { e.preventDefault(); prevPageBtn.click(); }
      if (e.key === '+') { scaleMode='manual'; scale = clamp(scale + SCALE_STEP, SCALE_MIN, SCALE_MAX); renderPage(currentPageNum); }
      if (e.key === '-') { scaleMode='manual'; scale = clamp(scale - SCALE_STEP, SCALE_MIN, SCALE_MAX); renderPage(currentPageNum); }
      if (e.key === '0') { scaleMode='manual'; scale = 1.0; renderPage(currentPageNum); }
      if (e.key.toLowerCase() === 'f') { scaleMode='fit-width'; renderPage(currentPageNum); } // f: ë§ì¶¤
      if (e.key === 'Home') { e.preventDefault(); renderPage(1); }
      if (e.key === 'End')  { e.preventDefault(); renderPage(pdfDoc.numPages); }
    });

    // ====== ê°€ë…ì„± ìœ í‹¸ ======
    function buildLaidOutText(textContent){
      const items = textContent.items || [];
      const lines = [];
      let buf = '';

      const pushLine = () => {
        const t = buf.trim();
        if (t.length) lines.push(t);
        buf = '';
      };

      for (const it of items) {
        const s = it.str || '';
        if (!s) continue;
        if (buf && !/[\s-]$/.test(buf) && !/^[\s,.;:!?)]/.test(s)) buf += ' ';
        buf += s;
        if (it.hasEOL) pushLine();
      }
      pushLine();

      // í•˜ì´í”ˆ ì¤„ë°”ê¿ˆ ë³´ì •
      for (let i=0;i<lines.length-1;i++){
        const a = lines[i], b = lines[i+1];
        if (/[A-Za-zê°€-í£0-9]-$/.test(a) && /^[a-zA-Zê°€-í£0-9]/.test(b)) {
          lines[i]   = a.replace(/-$/, '') + b.replace(/^\s+/, '');
          lines.splice(i+1, 1);
          i--;
        }
      }

      const paras = [];
      let pbuf = '';
      const isList = (t)=>/^\s*(?:[\u2022â€¢\-â€“]|\d+\.)\s+/.test(t);
      const endsWithSentencePunct = (t)=>/[.!?ã€‚ï¼ï¼Ÿâ€¦â€™â€)"\]]$/.test(t);
      const pushPara = ()=>{ const t = pbuf.trim(); if (t) paras.push(t); pbuf = ''; };

      for (let i=0;i<lines.length;i++){
        const L = lines[i].trim();
        if (!L) { pushPara(); continue; }
        if (isList(L)) { pushPara(); paras.push(L); continue; }
        if (pbuf) pbuf += ' ' + L; else pbuf = L;
        const next = lines[i+1]?.trim() || '';
        if (!next || isList(next) || endsWithSentencePunct(L)) pushPara();
      }
      pushPara();

      return paras.map(x => x.replace(/\s+/g,' ').trim()).join('\n\n');
    }

    function splitIntoChunks(text, maxLen = 4500) {
      const paragraphs = text.split(/\n{2,}/);
      const out = [];
      for (let p of paragraphs) {
        p = p.trim();
        if (!p) continue;
        if (p.length <= maxLen) { out.push(p); continue; }
        const sents = p.split(/(?<=[.!?ã€‚ï¼ï¼Ÿâ€¦])\s+/);
        let buf = '';
        for (const s of sents) {
          if ((buf + ' ' + s).trim().length <= maxLen) buf = (buf ? buf + ' ' : '') + s;
          else { if (buf) out.push(buf); buf = s; }
        }
        if (buf) out.push(buf);
      }
      return out.length ? out : [text.slice(0, maxLen)];
    }

    function escapeHtml(str){
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
