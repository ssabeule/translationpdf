<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PDF 실시간 번역 뷰어 (심플·가독성 업)</title>
  <style>
    :root { --brand:#007bff; --brand-dark:#0056b3; --bg:#f4f7f9; --panel:#fff; --border:#e0e0e0; --muted:#777; --text:#222; }
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen-Sans,Ubuntu,Cantarell,"Helvetica Neue",sans-serif;margin:0;display:flex;flex-direction:column;height:100vh;background:var(--bg);color:var(--text)}
    #header{background:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
    #header h1{margin:0;font-size:1.05rem;font-weight:700}
    #controls{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    #controls input[type="file"]{display:none}
    .btn{background:var(--brand);color:#fff;padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-size:.9rem}
    .btn:disabled{background:#a0a0a0;cursor:not-allowed}
    .btn:hover:not(:disabled){background:var(--brand-dark)}
    .pill{display:flex;align-items:center;gap:6px;background:#fff;border:1px solid var(--border);padding:6px 8px;border-radius:8px}
    .pill input[type="range"]{width:120px}
    select{padding:7px 10px;border:1px solid var(--border);border-radius:8px;background:#fff}
    #container{flex:1;display:flex;gap:14px;padding:14px;min-height:0}
    #pdf-viewer-container,#translation-container{flex:1;background:var(--panel);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.08);display:flex;flex-direction:column;min-height:0;overflow:hidden}
    .panel-header{padding:10px 14px;background:#f8f9fa;border-bottom:1px solid var(--border);font-weight:700;color:#555}
    #pdf-viewer{flex:1;overflow:auto;padding:10px}
    canvas{display:block;max-width:100%;box-shadow:0 0 10px rgba(0,0,0,.08)}
    #translation-output{flex:1;overflow:auto;padding:18px;display:flex;justify-content:center}
    .translation-inner{width:100%;max-width:var(--colWidth, 820px);font-size:var(--fontSize, 18px);line-height:1.8;letter-spacing:.2px;white-space:pre-wrap;word-break:keep-all;color:#222}
    .translation-inner p{margin:0 0 1em}
    .muted{font-size:1.02rem;color:var(--muted);text-align:center;margin-top:38px}
  </style>
</head>
<body>
  <div id="header">
    <h1>PDF 실시간 번역 뷰어</h1>
    <div id="controls">
      <label class="btn" for="file-input">PDF 파일 선택</label>
      <input type="file" id="file-input" accept=".pdf"/>

      <div class="pill">
        <button id="prev-page" class="btn" disabled>이전</button>
        <span>페이지 <span id="page-num">0</span>/<span id="page-count">0</span></span>
        <button id="next-page" class="btn" disabled>다음</button>
      </div>

      <select id="target-lang" title="번역 언어">
        <option value="ko">한국어</option>
        <option value="en">영어</option>
        <option value="ja">일본어</option>
        <option value="zh-CN">중국어(간체)</option>
        <option value="es">스페인어</option>
      </select>

      <div class="pill">
        <span>글자</span>
        <input id="font-size" type="range" min="16" max="24" value="18">
      </div>
      <div class="pill">
        <span>열폭</span>
        <input id="col-width" type="range" min="640" max="1000" value="820">
      </div>
    </div>
  </div>

  <div id="container">
    <div id="pdf-viewer-container">
      <div class="panel-header">원본 PDF</div>
      <div id="pdf-viewer"><div class="muted">오른쪽에서 PDF 파일을 선택하세요.</div></div>
    </div>

    <div id="translation-container">
      <div class="panel-header">번역 결과</div>
      <div id="translation-output">
        <div class="translation-inner" id="translation-inner">
          <div class="muted">PDF를 선택하면 번역이 표시됩니다.</div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    /* ★ 네 최신 /exec 주소로 바꿔 넣기 */
    const APPS_SCRIPT_URL =
      "https://script.google.com/macros/s/여기에-네-최신-배포-아이디/exec";

    /* 같은 출처 pdf.js (lib/ 폴더의 같은 버전 파일 2개 필요) */
    import * as pdfjsLib from './lib/pdf.mjs';
    pdfjsLib.GlobalWorkerOptions.workerSrc = './lib/pdf.worker.mjs';

    // DOM
    const fileInput = document.getElementById('file-input');
    const pdfViewer = document.getElementById('pdf-viewer');
    const translationInner = document.getElementById('translation-inner');
    const pageNumSpan = document.getElementById('page-num');
    const pageCountSpan = document.getElementById('page-count');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const targetLangSelect = document.getElementById('target-lang');
    const fontSizeRange = document.getElementById('font-size');
    const colWidthRange = document.getElementById('col-width');

    // 상태
    let pdfDoc = null, currentPageNum = 1, isRendering = false;

    // 가독성 조절
    function applyReaderStyle(){
      translationInner.style.setProperty('--fontSize', fontSizeRange.value + 'px');
      translationInner.style.setProperty('--colWidth', colWidthRange.value + 'px');
    }
    fontSizeRange.addEventListener('input', applyReaderStyle);
    colWidthRange.addEventListener('input', applyReaderStyle);
    applyReaderStyle();

    // 간단 POST (x-www-form-urlencoded) → 사전검사(프리플라이트) 회피
    async function translateText(textToTranslate, targetLang) {
      if (!APPS_SCRIPT_URL.includes('/exec')) {
        return '오류: APPS_SCRIPT_URL에 최신 /exec 주소를 넣어주세요.';
      }
      try {
        const body = 'text=' + encodeURIComponent(textToTranslate) +
                     '&targetLang=' + encodeURIComponent(targetLang);
        const res = await fetch(APPS_SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });
        if (!res.ok) throw new Error('서버 응답 오류: ' + res.status);
        const data = await res.json();
        return data.translatedText || (data.error ? ('번역 오류: ' + data.error) : '');
      } catch (err) {
        console.error('번역 API 호출 오류:', err);
        return '번역 실패: ' + err.message;
      }
    }

    // 파일 선택
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file || file.type !== 'application/pdf') { alert('PDF 파일만 선택하세요.'); return; }
      const fr = new FileReader();
      fr.onload = async (evt) => {
        const arr = new Uint8Array(evt.target.result);
        translationInner.innerHTML = '<div class="muted">PDF 파일을 불러오는 중...</div>';
        try {
          const task = pdfjsLib.getDocument(arr);
          pdfDoc = await task.promise;
          pageCountSpan.textContent = pdfDoc.numPages;
          currentPageNum = 1;
          await renderPage(currentPageNum);
        } catch (err) {
          console.error('PDF 로딩 오류:', err);
          translationInner.innerHTML = '<div class="muted">PDF 로딩 실패.</div>';
        }
      };
      fr.readAsArrayBuffer(file);
    });

    // 페이지 렌더
    async function renderPage(num) {
      if (!pdfDoc || isRendering) return;
      isRendering = true;

      try {
        const page = await pdfDoc.getPage(num);
        const viewport = page.getViewport({ scale: 1.8 });

        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = viewport.width; canvas.height = viewport.height;
        await page.render({ canvasContext: ctx, viewport }).promise;

        pdfViewer.innerHTML = '';
        pdfViewer.appendChild(canvas);

        currentPageNum = num;
        pageNumSpan.textContent = String(num);
        prevPageBtn.disabled = (num <= 1);
        nextPageBtn.disabled = (num >= pdfDoc.numPages);

        // 텍스트 추출 → 예쁘게 정리 → 번역
        translationInner.innerHTML = `<div class="muted">번역 중... (페이지 ${num}/${pdfDoc.numPages})</div>`;
        const textContent = await page.getTextContent();
        const raw = (textContent.items.map(it => it.str).join(' ') || '').trim();

        if (!raw) {
          translationInner.innerHTML = '<div class="muted">이 페이지에는 번역할 텍스트가 없습니다.</div>';
        } else {
          const pretty = prettify(raw);
          const chunks = splitIntoChunks(pretty, 4500);
          const out = [];
          for (let i = 0; i < chunks.length; i++) {
            const part = await translateText(chunks[i], targetLangSelect.value);
            out.push(part || '');
            translationInner.innerHTML = `<div class="muted">번역 중... (${i+1}/${chunks.length})</div>`;
          }
          const html = out.join('\n')
            .split(/\n{2,}/)
            .map(p => `<p>${escapeHtml(p.trim())}</p>`)
            .join('');
          translationInner.innerHTML = html || '<div class="muted">빈 결과</div>';
          document.getElementById('translation-output').scrollTop = 0;
        }
      } catch (err) {
        console.error(`페이지 ${num} 표시/번역 실패:`, err);
        translationInner.innerHTML = `<div class="muted">페이지 ${num} 표시/번역 실패</div>`;
      } finally {
        isRendering = false;
      }
    }

    // 버튼/키보드 네비
    prevPageBtn.addEventListener('click', () => { if (currentPageNum > 1) renderPage(currentPageNum - 1); });
    nextPageBtn.addEventListener('click', () => { if (pdfDoc && currentPageNum < pdfDoc.numPages) renderPage(currentPageNum + 1); });
    targetLangSelect.addEventListener('change', () => { if (pdfDoc) renderPage(currentPageNum); });
    window.addEventListener('keydown', (e) => {
      if (!pdfDoc) return;
      if (e.key === 'ArrowRight' || e.key === 'PageDown') { e.preventDefault(); nextPageBtn.click(); }
      if (e.key === 'ArrowLeft'  || e.key === 'PageUp')   { e.preventDefault(); prevPageBtn.click(); }
      if (e.key === 'Home') { e.preventDefault(); renderPage(1); }
      if (e.key === 'End')  { e.preventDefault(); renderPage(pdfDoc.numPages); }
    });

    // 유틸: 문장/문단 가다듬기
    function splitIntoChunks(text, maxLen = 4500) {
      const sentences = text.split(/(?<=[.!?。！？])\s+/);
      const chunks = []; let buf = '';
      for (const s of sentences) {
        if ((buf + ' ' + s).trim().length <= maxLen) buf = (buf ? buf + ' ' : '') + s;
        else {
          if (buf) chunks.push(buf);
          if (s.length > maxLen) {
            for (let i = 0; i < s.length; i += maxLen) chunks.push(s.slice(i, i + maxLen));
            buf = '';
          } else buf = s;
        }
      }
      if (buf) chunks.push(buf);
      return chunks;
    }
    function prettify(t){
      let s = t.replace(/\s+/g,' ').trim();
      s = s.replace(/([.!?。！？])\s+/g, '$1  \n')   // 문장 뒤 두 칸+줄바꿈
           .replace(/([:;])\s+/g, '$1 \n')          // 콜론/세미콜론 뒤 줄바꿈
           .replace(/\s+([)\]])/g, '$1');           // 닫는 괄호 앞 공백 제거
      // 너무 짧은 줄은 앞줄에 붙이기
      s = s.split('\n').reduce((acc, line) => {
        const L = line.trim();
        if (!acc.length) return [L];
        if (L.length < 40 && !/[.!?。！？]$/.test(L)) acc[acc.length-1] += ' ' + L;
        else acc.push(L);
        return acc;
      }, []).join('\n\n');
      return s;
    }
    function escapeHtml(str){
      return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
